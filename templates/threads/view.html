{% extends "base.html" %}

{% block title %}{{ thread.subject }} - {{ config.site_name }}{% endblock %}

{% block content %}
<article class="thread-view">
    <header class="thread-header">
        <a href="/g/{{ group }}" class="back-link">&larr; Back to {{ group }}</a>
        <h1>{{ thread.subject }}</h1>
        <p class="thread-stats">
            {{ pagination.total_items }} messages in thread
            {% if pagination.total_pages > 1 %}
            (page {{ pagination.current_page }} of {{ pagination.total_pages }})
            {% endif %}
        </p>
    </header>

    {% if pagination.total_pages > 1 %}
    {% include "partials/pagination.html" %}
    {% endif %}

    {% set page_start = (pagination.current_page - 1) * pagination.items_per_page %}
    {% set page_end = page_start + pagination.items_per_page %}

    <div class="thread-comments">
        {% for comment in comments %}
        {% if loop.index0 >= page_start and loop.index0 < page_end %}
        <div class="comment depth-{{ comment.depth }}"
             id="msg-{{ comment.message_id | urlencode_strict }}"
             data-depth="{{ comment.depth }}"
             {% if comment.starts_collapsed %}data-collapsed="true"{% endif %}>
            {% if comment.article %}
            <div class="comment-header">
                <a href="/a/{{ comment.message_id | urlencode_strict }}?back=/g/{{ group }}/thread/{{ thread.root_message_id | urlencode_strict }}{% if pagination.current_page > 1 %}%3Fpage%3D{{ pagination.current_page }}{% endif %}" class="comment-title">
                    {{ comment.article.subject }}
                </a>
                <div class="comment-meta">
                    <span class="author">{{ comment.article.from }}</span>
                    <span class="separator">Â·</span>
                    <span class="date">{{ comment.article.date | timeago }}</span>
                </div>
            </div>
            <div class="comment-body">
                {% if comment.article.body %}
                <pre class="article-text article-preview">{{ comment.article.body | preview(lines=10) }}</pre>
                {% if comment.article.body | has_more_lines(lines=10) %}
                <a href="/a/{{ comment.message_id | urlencode_strict }}?back=/g/{{ group }}/thread/{{ thread.root_message_id | urlencode_strict }}{% if pagination.current_page > 1 %}%3Fpage%3D{{ pagination.current_page }}{% endif %}" class="read-more">Read more</a>
                {% endif %}
                {% else %}
                <p class="no-content">Article content not available.</p>
                {% endif %}
            </div>
            {% if user and can_post %}
            <div class="comment-actions">
                <button type="button" class="reply-toggle" onclick="toggleReplyForm(this)">Reply</button>
            </div>
            <div class="reply-form-container" style="display: none;">
                <form action="/a/{{ comment.message_id | urlencode_strict }}/reply" method="POST" class="reply-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="group" value="{{ group }}">
                    <input type="hidden" name="subject" value="Re: {{ comment.article.subject }}">
                    <input type="hidden" name="references" value="{{ comment.references | default(value='') }}">
                    <textarea name="body" required rows="5" maxlength="64000" placeholder="Write your reply..."></textarea>
                    <div class="reply-form-actions">
                        <button type="submit" class="submit-button">Post Reply</button>
                        <button type="button" class="cancel-button" onclick="toggleReplyForm(this)">Cancel</button>
                    </div>
                </form>
            </div>
            {% endif %}
            {% else %}
            <div class="comment-placeholder">
                [Missing article: {{ comment.message_id }}]
            </div>
            {% endif %}
            {% if comment.starts_collapsed %}
            <button class="expand-replies" data-count="{{ comment.descendant_count }}">
                Show {{ comment.descendant_count }} more replies
            </button>
            {% endif %}
        </div>
        {% endif %}
        {% endfor %}
    </div>

    {% if pagination.total_pages > 1 %}
    {% include "partials/pagination.html" %}
    {% endif %}
</article>
{% endblock %}
