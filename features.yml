# features.yml - September NNTP Web Gateway
# Generated from existing codebase analysis
#
# This file tracks features, requirements, and test coverage for the September project.
# See ARCHITECTURE.md for system overview.

# =============================================================================
# Feature 1: NNTP Worker Pool
# =============================================================================
feature: "NNTP Worker Pool"
phase: Complete
version: 1
changelog: |
  ## [1]
  ### Added
  - Initial feature tracking from existing codebase
decisions:
  - Workers maintain persistent NNTP connections with auto-reconnect
  - Three priority levels (High/Normal/Low) for request scheduling
  - Aging mechanism prevents starvation of low-priority requests under sustained load
  - Each server has its own independent worker pool
known-issues: []
requirements:
  wp-1:
    description: "The system SHALL create a configurable number of workers per NNTP server"
    status: Complete
    tested-by: [py-worker-count-logged]
  wp-2:
    description: "When processing requests, workers SHALL check queues in priority order (High, Normal, Low)"
    status: Complete
    tested-by: [rust-priority-ordering]
  wp-3:
    description: "The system SHALL assign GetArticle requests to High priority"
    status: Complete
    tested-by: [rust-priority-get-article]
  wp-4:
    description: "The system SHALL assign PostArticle requests to High priority"
    status: Complete
    tested-by: [rust-priority-post-article]
  wp-5:
    description: "The system SHALL assign CheckArticleExists requests to High priority"
    status: Complete
    tested-by: [rust-priority-check-article]
  wp-6:
    description: "The system SHALL assign GetThreads requests to Normal priority"
    status: Complete
    tested-by: [rust-priority-get-threads]
  wp-7:
    description: "The system SHALL assign GetGroups requests to Normal priority"
    status: Complete
    tested-by: [rust-priority-get-groups]
  wp-8:
    description: "The system SHALL assign GetGroupStats requests to Low priority"
    status: Complete
    tested-by: [rust-priority-get-group-stats]
  wp-9:
    description: "The system SHALL assign GetNewArticles requests to Low priority"
    status: Complete
    tested-by: [rust-priority-get-new-articles]
  wp-10:
    description: "When a low-priority request has waited longer than NNTP_PRIORITY_AGING_SECS, the system SHALL process it before normal-priority requests"
    status: Complete
    tested-by: [rust-priority-aging-threshold]
  wp-11:
    description: "When a worker loses its NNTP connection, it SHALL automatically reconnect after NNTP_RECONNECT_DELAY_SECS"
    status: Complete
    tested-by: [manual-worker-reconnect]
  wp-12:
    description: "The system SHALL detect server capabilities via the CAPABILITIES command on connection"
    status: Complete
    tested-by: [py-capabilities-logged]
  wp-13:
    description: "When HDR command is supported with References in overview, the system SHALL use OVER for thread fetching"
    status: Complete
    tested-by: [py-over-command-logged]
  wp-14:
    description: "When OVER is not available, the system SHALL fall back to HDR command"
    status: Complete
    tested-by: [rust-thread-fetch-method-hdr-fallback]
  wp-15:
    description: "When neither OVER nor HDR is available, the system SHALL fall back to HEAD command"
    status: Complete
    tested-by: [rust-thread-fetch-method-head-fallback]
test-cases:
  rust-priority-ordering:
    name: "test_priority_ordering"
    file: "src/nntp/messages.rs"
    description: "Given Priority enum values, when compared, then High < Normal < Low"
    passing: true
    type: unit
  rust-priority-get-article:
    name: "test_priority_get_article_is_high"
    file: "src/nntp/messages.rs"
    description: "Given GetArticle request, when priority() called, then returns High"
    passing: true
    type: unit
  rust-priority-post-article:
    name: "test_priority_post_article_is_high"
    file: "src/nntp/messages.rs"
    description: "Given PostArticle request, when priority() called, then returns High"
    passing: true
    type: unit
  rust-priority-check-article:
    name: "test_priority_check_article_exists_is_high"
    file: "src/nntp/messages.rs"
    description: "Given CheckArticleExists request, when priority() called, then returns High"
    passing: true
    type: unit
  rust-priority-get-threads:
    name: "test_priority_get_threads_is_normal"
    file: "src/nntp/messages.rs"
    description: "Given GetThreads request, when priority() called, then returns Normal"
    passing: true
    type: unit
  rust-priority-get-groups:
    name: "test_priority_get_groups_is_normal"
    file: "src/nntp/messages.rs"
    description: "Given GetGroups request, when priority() called, then returns Normal"
    passing: true
    type: unit
  rust-priority-get-group-stats:
    name: "test_priority_get_group_stats_is_low"
    file: "src/nntp/messages.rs"
    description: "Given GetGroupStats request, when priority() called, then returns Low"
    passing: true
    type: unit
  rust-priority-get-new-articles:
    name: "test_priority_get_new_articles_is_low"
    file: "src/nntp/messages.rs"
    description: "Given GetNewArticles request, when priority() called, then returns Low"
    passing: true
    type: unit
  rust-priority-display:
    name: "test_priority_display"
    file: "src/nntp/messages.rs"
    description: "Given Priority enum, when formatted, then displays lowercase string"
    passing: true
    type: unit
  rust-nntp-error-display:
    name: "test_nntp_error_display"
    file: "src/nntp/messages.rs"
    description: "Given NntpError, when formatted, then displays error message"
    passing: true
    type: unit
  rust-priority-aging-threshold:
    name: "test_priority_aging_threshold_is_10_seconds"
    file: "src/nntp/worker.rs"
    description: "Given NNTP_PRIORITY_AGING_SECS constant, then equals 10 seconds"
    passing: true
    type: unit
  rust-thread-fetch-method-prefers-over:
    name: "test_thread_fetch_method_prefers_over"
    file: "src/nntp/worker.rs"
    description: "Given server with OVER and HDR with References, when determining fetch method, then returns FetchMethod::Over"
    passing: true
    type: unit
  rust-thread-fetch-method-hdr-fallback:
    name: "test_thread_fetch_method_hdr_fallback"
    file: "src/nntp/worker.rs"
    description: "Given server with HDR but no OVER, when determining fetch method, then returns FetchMethod::Hdr"
    passing: true
    type: unit
  rust-thread-fetch-method-head-fallback:
    name: "test_thread_fetch_method_head_fallback"
    file: "src/nntp/worker.rs"
    description: "Given server without OVER or HDR, when determining fetch method, then returns FetchMethod::Head"
    passing: true
    type: unit
  rust-server-capabilities-parses-hdr:
    name: "test_server_capabilities_from_capabilities_parses_hdr"
    file: "src/nntp/worker.rs"
    description: "Given CAPABILITIES response with HDR, when parsed, then hdr=true"
    passing: true
    type: unit
  rust-server-capabilities-parses-over:
    name: "test_server_capabilities_from_capabilities_parses_over"
    file: "src/nntp/worker.rs"
    description: "Given CAPABILITIES response with OVER, when parsed, then over=true"
    passing: true
    type: unit
  rust-server-capabilities-parses-post:
    name: "test_server_capabilities_from_capabilities_parses_post"
    file: "src/nntp/worker.rs"
    description: "Given CAPABILITIES response with POST, when parsed, then post_capability=true"
    passing: true
    type: unit
  rust-server-capabilities-parses-list-variants:
    name: "test_server_capabilities_from_capabilities_parses_list_variants"
    file: "src/nntp/worker.rs"
    description: "Given CAPABILITIES response with LIST variants, when parsed, then list_overview_fmt and list_headers are true"
    passing: true
    type: unit
  rust-server-capabilities-can-post-requires-both:
    name: "test_server_capabilities_can_post_requires_both"
    file: "src/nntp/worker.rs"
    description: "Given capabilities, when checking can_post, then requires both post_greeting and post_capability"
    passing: true
    type: unit
  py-worker-count-logged:
    name: "test_worker_count_logged_on_startup"
    file: "tests/integration/test_observability.py"
    description: "Given September startup logs, when checked, then shows worker spawn count"
    passing: true
    type: integration
  manual-worker-reconnect:
    name: "manual_test_worker_reconnect"
    file: "manual"
    description: "Manual: 1) Start September connected to NNTP server. 2) Kill NNTP server connection. 3) Verify logs show reconnect attempt after NNTP_RECONNECT_DELAY_SECS (5s). 4) Restart NNTP server and verify reconnection succeeds."
    passing: true
    type: manual
  py-capabilities-logged:
    name: "test_capabilities_detection_logged"
    file: "tests/integration/test_observability.py"
    description: "Given NNTP connection, when logs checked, then shows detected capabilities"
    passing: true
    type: integration
  py-over-command-logged:
    name: "test_over_command_usage_logged"
    file: "tests/integration/test_observability.py"
    description: "Given thread list fetch, when logs checked, then shows OVER command usage"
    passing: true
    type: integration
---
# =============================================================================
# Feature 2: Request Coalescing
# =============================================================================
feature: "Request Coalescing"
phase: Complete
version: 1
changelog: |
  ## [1]
  ### Added
  - Initial feature tracking from existing codebase
decisions:
  - Coalescing occurs at both NntpService (per-server) and NntpFederatedService (global) levels
  - Uses broadcast channels to notify all waiters of shared results
  - Pending requests include timestamps for timeout checking; expired entries are removed and new requests started
  - Arc-wrapped types avoid cloning large responses on broadcast
known-issues: []
requirements:
  rc-1:
    description: "When multiple requests arrive for the same article, the system SHALL coalesce them into a single NNTP request"
    status: Complete
    tested-by: [py-coalesce-articles]
  rc-2:
    description: "When multiple requests arrive for the same group's threads, the system SHALL coalesce them into a single NNTP request"
    status: Complete
    tested-by: [py-coalesce-threads]
  rc-3:
    description: "When multiple requests arrive for the group list, the system SHALL coalesce them into a single NNTP request"
    status: Complete
    tested-by: [py-coalesce-groups]
  rc-4:
    description: "When multiple requests arrive for the same group stats, the system SHALL coalesce them into a single NNTP request"
    status: Complete
    tested-by: [py-coalesce-stats]
test-cases:
  py-coalesce-articles:
    name: "test_article_coalescing_logged"
    file: "tests/integration/test_observability.py"
    description: "Given parallel article requests, when logs checked, then shows coalesced=true"
    passing: true
    type: integration
  py-coalesce-threads:
    name: "test_threads_coalescing_logged"
    file: "tests/integration/test_observability.py"
    description: "Given parallel thread list requests, when logs checked, then shows coalesced=true"
    passing: true
    type: integration
  py-coalesce-groups:
    name: "test_groups_coalescing_logged"
    file: "tests/integration/test_observability.py"
    description: "Given parallel group list requests, when logs checked, then shows coalesced=true"
    passing: true
    type: integration
  py-coalesce-stats:
    name: "test_stats_coalescing_logged"
    file: "tests/integration/test_observability.py"
    description: "Given parallel stats requests, when logs checked, then shows coalesced=true"
    passing: true
    type: integration
---
# =============================================================================
# Feature 3: Federated Multi-Server
# =============================================================================
feature: "Federated Multi-Server"
phase: Complete
version: 1
changelog: |
  ## [1]
  ### Added
  - Initial feature tracking from existing codebase
decisions:
  - Servers are treated as a federated pool sharing the same Usenet backbone
  - Requests try servers in configured priority order
  - Group lists are merged from all servers
  - Each server maintains independent caching and worker pools
known-issues: []
requirements:
  fm-1:
    description: "The system SHALL support configuration of multiple NNTP servers"
    status: Complete
    tested-by: [manual-multi-server-config]
  fm-2:
    description: "When fetching articles, the system SHALL try servers in priority order until success"
    status: Complete
    tested-by: [manual-server-priority-order]
  fm-3:
    description: "When a server fails, the system SHALL automatically failover to the next server"
    status: Complete
    tested-by: [manual-server-failover]
  fm-4:
    description: "When fetching group lists, the system SHALL merge results from all servers"
    status: Complete
    tested-by: [manual-groups-merge]
  fm-6:
    description: "Each server SHALL have independent connection and request timeout settings"
    status: Complete
    tested-by: [rust-per-server-timeout-override, rust-per-server-timeout-fallback]
  fm-8:
    description: "The system SHALL track posting-capable worker count per server"
    status: Complete
    tested-by: [rust-server-capabilities-can-post-requires-both]
test-cases:
  manual-multi-server-config:
    name: "manual_test_multi_server_config"
    file: "manual"
    description: "Manual: 1) Configure two [[server]] sections in september.toml. 2) Start September. 3) Verify logs show both servers initializing with 'Spawned NNTP workers' for each."
    passing: true
    type: manual
  manual-server-priority-order:
    name: "manual_test_server_priority_order"
    file: "manual"
    description: "Manual: 1) Configure two servers with different article availability. 2) Request article only on primary. 3) Verify primary serves it. 4) Request article only on secondary. 5) Verify failover occurs."
    passing: true
    type: manual
  manual-server-failover:
    name: "manual_test_server_failover"
    file: "manual"
    description: "Manual: 1) Configure two servers, stop primary. 2) Request an article. 3) Verify logs show first server error and fallback to secondary. 4) Verify article is returned."
    passing: true
    type: manual
  manual-groups-merge:
    name: "manual_test_groups_merge"
    file: "manual"
    description: "Manual: 1) Configure two servers with different group sets. 2) Access homepage. 3) Verify groups from both servers appear in the list."
    passing: true
    type: manual
  rust-per-server-timeout-override:
    name: "test_nntp_server_config_request_timeout_uses_override"
    file: "src/config.rs"
    description: "Given server with request_timeout_seconds override, when getting timeout, then uses server value"
    passing: true
    type: unit
  rust-per-server-timeout-fallback:
    name: "test_nntp_server_config_request_timeout_falls_back_to_global"
    file: "src/config.rs"
    description: "Given server without timeout override, when getting timeout, then uses global value"
    passing: true
    type: unit
---
# =============================================================================
# Feature 4: TLS Connection Handling
# =============================================================================
feature: "TLS Connection Handling"
phase: Complete
version: 1
changelog: |
  ## [1]
  ### Added
  - Initial feature tracking from existing codebase
decisions:
  - TLS is attempted first for all connections
  - If credentials are configured, TLS is required (no fallback to plain)
  - If no credentials, fall back to plain TCP if TLS fails
  - Uses system root certificates for TLS validation
known-issues: []
requirements:
  tls-1:
    description: "When connecting to an NNTP server, the system SHALL attempt TLS first"
    status: Complete
    tested-by: [manual-tls-first]
  tls-2:
    description: "When credentials are configured, the system SHALL require TLS (no plain fallback)"
    status: Complete
    tested-by: [rust-requires-tls-for-credentials]
  tls-3:
    description: "When no credentials are configured and TLS fails, the system SHALL fall back to plain TCP"
    status: Complete
    tested-by: [manual-tls-plain-fallback]
  tls-5:
    description: "The system SHALL log the connection type (TLS or plain) for debugging"
    status: Complete
    tested-by: [py-tls-connection-logged]
  tls-6:
    description: "The system SHALL support optional allow_insecure_auth flag for testing"
    status: Complete
    tested-by: [rust-requires-tls-for-credentials]
test-cases:
  manual-tls-first:
    name: "manual_test_tls_attempted_first"
    file: "manual"
    description: "Manual: 1) Configure NNTP server supporting TLS on port 563. 2) Start September with debug logging. 3) Verify logs show TLS connection attempt before any NNTP commands."
    passing: true
    type: manual
  manual-tls-plain-fallback:
    name: "manual_test_tls_plain_fallback"
    file: "manual"
    description: "Manual: 1) Configure server without TLS support and no credentials. 2) Start September. 3) Verify logs show TLS attempt failed, then successful plain TCP connection."
    passing: true
    type: manual
  py-tls-connection-logged:
    name: "test_tls_connection_type_logged"
    file: "tests/integration/test_observability.py"
    description: "Given NNTP connection, when logs checked, then shows connection type (TLS or plain)"
    passing: true
    type: integration
  rust-requires-tls-for-credentials:
    name: "test_nntp_server_config_requires_tls_for_credentials"
    file: "src/config.rs"
    description: "Given credentials with allow_insecure_auth, when checked, then TLS requirement reflects flag"
    passing: true
    type: unit
---
# =============================================================================
# Feature 5: NNTP Caching
# =============================================================================
feature: "NNTP Caching"
phase: Complete
version: 1
changelog: |
  ## [1]
  ### Added
  - Initial feature tracking from existing codebase
decisions:
  - Caching is handled at the NntpFederatedService level using moka async caches
  - Different cache TTLs for different content types based on mutability
  - Negative caching for not-found articles with short TTL
  - Cache sizes are configurable
known-issues: []
requirements:
  cache-1:
    description: "The system SHALL cache articles with configurable TTL (default 24 hours)"
    status: Complete
    tested-by: [rust-cache-config-article-ttl]
  cache-2:
    description: "The system SHALL cache thread lists with configurable TTL (default 30 minutes)"
    status: Complete
    tested-by: [rust-cache-config-threads-ttl]
  cache-3:
    description: "The system SHALL cache individual threads with configurable TTL (default 30 minutes)"
    status: Complete
    tested-by: [rust-cache-config-threads-ttl]
  cache-4:
    description: "The system SHALL cache group lists with configurable TTL (default 1 hour)"
    status: Complete
    tested-by: [rust-cache-config-groups-ttl]
  cache-5:
    description: "The system SHALL cache group stats with configurable TTL (default 30 minutes)"
    status: Complete
    tested-by: [rust-cache-config-threads-ttl]
  cache-6:
    description: "The system SHALL maintain a negative cache for not-found articles with short TTL"
    status: Complete
    tested-by: [rust-negative-cache-ttl]
  cache-7:
    description: "The system SHALL support configurable maximum cache sizes"
    status: Complete
    tested-by: [rust-cache-config-max-articles, rust-cache-config-max-thread-lists, rust-cache-config-max-group-stats]
test-cases:
  rust-cache-config-article-ttl:
    name: "test_cache_config_default_article_ttl"
    file: "src/config.rs"
    description: "Given CacheConfig default, then article_ttl_seconds equals 86400 (24 hours)"
    passing: true
    type: unit
  rust-cache-config-threads-ttl:
    name: "test_cache_config_default_threads_ttl"
    file: "src/config.rs"
    description: "Given CacheConfig default, then threads_ttl_seconds equals 1800 (30 minutes)"
    passing: true
    type: unit
  rust-cache-config-groups-ttl:
    name: "test_cache_config_default_groups_ttl"
    file: "src/config.rs"
    description: "Given CacheConfig default, then groups_ttl_seconds equals 3600 (1 hour)"
    passing: true
    type: unit
  rust-cache-config-max-articles:
    name: "test_cache_config_default_max_articles"
    file: "src/config.rs"
    description: "Given CacheConfig default, then max_articles equals 10000"
    passing: true
    type: unit
  rust-cache-config-max-thread-lists:
    name: "test_cache_config_default_max_thread_lists"
    file: "src/config.rs"
    description: "Given CacheConfig default, then max_thread_lists equals 100"
    passing: true
    type: unit
  rust-cache-config-max-group-stats:
    name: "test_cache_config_default_max_group_stats"
    file: "src/config.rs"
    description: "Given CacheConfig default, then max_group_stats equals 1000"
    passing: true
    type: unit
  rust-negative-cache-ttl:
    name: "test_negative_cache_ttl_is_30_seconds"
    file: "src/config.rs"
    description: "Given NNTP_NEGATIVE_CACHE_TTL_SECS constant, then equals 30 seconds"
    passing: true
    type: unit
---
# =============================================================================
# Feature 6: Incremental Updates
# =============================================================================
feature: "Incremental Updates"
phase: Complete
version: 1
changelog: |
  ## [1]
  ### Added
  - Initial feature tracking from existing codebase
decisions:
  - Thread caches store last article number as high water mark
  - On cache hit, only fetch articles since high water mark (delta fetch)
  - Merge new articles into existing cached threads, updating last reply dates
  - Debounce incremental checks to max 1 per second per group
known-issues: []
requirements:
  inc-4:
    description: "The system SHALL debounce incremental checks to maximum 1 per second per group"
    status: Complete
    tested-by: [rust-incremental-debounce]
test-cases:
  rust-incremental-debounce:
    name: "test_incremental_debounce_is_1_second"
    file: "src/config.rs"
    description: "Given INCREMENTAL_DEBOUNCE_MS constant, then equals 1000 (1 second)"
    passing: true
    type: unit
---
# =============================================================================
# Feature 7: Activity-Proportional Refresh
# =============================================================================
feature: "Activity-Proportional Refresh"
phase: Complete
version: 1
changelog: |
  ## [1]
  ### Added
  - Initial feature tracking from existing codebase
decisions:
  - Each active group has its own background refresh task
  - Refresh rate scales logarithmically with request activity
  - Activity tracked via circular buffer maintaining 5-minute moving average
  - Tasks stop when group becomes inactive (no requests in window)
known-issues: []
requirements:
  apr-3:
    description: "The system SHALL spawn a refresh task for each group with activity"
    status: Complete
    tested-by: [py-apr-spawn-logged]
  apr-4:
    description: "At high activity (10,000 req/s), the refresh period SHALL be 1 second"
    status: Complete
    tested-by: [rust-apr-high-activity]
  apr-5:
    description: "At low activity (any requests in 5 minutes), the refresh period SHALL be 30 seconds"
    status: Complete
    tested-by: [rust-apr-low-activity]
  apr-6:
    description: "The system SHALL use logarithmic scaling between min and max refresh periods"
    status: Complete
    tested-by: [rust-apr-log-scale]
  apr-8:
    description: "Background refresh requests SHALL use Low priority"
    status: Complete
    tested-by: [rust-priority-get-new-articles]
  apr-10:
    description: "When time advances, the system SHALL clear expired buckets and subtract their counts"
    status: Complete
    tested-by: [rust-apr-bucket-expiry]
test-cases:
  py-apr-spawn-logged:
    name: "test_activity_refresh_spawn_logged"
    file: "tests/integration/test_observability.py"
    description: "Given group activity, when logs checked, then shows background refresh spawn"
    passing: true
    type: integration
  rust-apr-high-activity:
    name: "test_calculate_refresh_period_high_activity"
    file: "src/nntp/federated.rs"
    description: "Given 10000 rps, when calculate_refresh_period called, then returns ~1 second"
    passing: true
    type: unit
  rust-apr-low-activity:
    name: "test_calculate_refresh_period_low_activity"
    file: "src/nntp/federated.rs"
    description: "Given minimal activity (0.003 rps), when calculate_refresh_period called, then returns ~30 seconds"
    passing: true
    type: unit
  rust-apr-log-scale:
    name: "test_calculate_refresh_period_log_scale"
    file: "src/nntp/federated.rs"
    description: "Given 100 rps, when calculate_refresh_period called, then returns value between 1s and 30s using log10 interpolation"
    passing: true
    type: unit
  rust-apr-bucket-expiry:
    name: "test_group_activity_advance_clears_buckets"
    file: "src/nntp/federated.rs"
    description: "Given buckets with counts, when advance_to called with future time, then old buckets cleared and total_requests decremented"
    passing: true
    type: unit
---
# =============================================================================
# Feature 8: Group Stats Refresh
# =============================================================================
feature: "Group Stats Refresh"
phase: Complete
version: 1
changelog: |
  ## [1]
  ### Added
  - Initial feature tracking from existing codebase
decisions:
  - One long-running task per group for stats refresh
  - Fixed 1-hour interval between refreshes
  - Coordinator detects new/removed groups and manages tasks
known-issues: []
requirements:
  gsr-1:
    description: "The system SHALL spawn a refresh task for each known group's statistics"
    status: Complete
    tested-by: [py-gsr-spawn-logged]
  gsr-3:
    description: "Group stats refresh requests SHALL use Low priority"
    status: Complete
    tested-by: [rust-priority-get-group-stats]
test-cases:
  py-gsr-spawn-logged:
    name: "test_stats_refresh_spawn_logged"
    file: "tests/integration/test_observability.py"
    description: "Given September startup, when logs checked, then shows stats refresh spawn"
    passing: true
    type: integration
---
# =============================================================================
# Feature 9: HTTP Routing
# =============================================================================
feature: "HTTP Routing"
phase: Complete
version: 1
changelog: |
  ## [1]
  ### Added
  - Initial feature tracking from existing codebase
decisions:
  - Routes organized by content type with per-route cache headers
  - Auth and post routes have no caching (stateful)
  - Request ID middleware enables log correlation
known-issues: []
requirements:
  rt-1:
    description: "The system SHALL serve the homepage at GET /"
    status: Complete
    tested-by: [py-homepage-loads]
  rt-2:
    description: "The system SHALL serve group browsing at GET /browse/{prefix}"
    status: Complete
    tested-by: [py-browse-test-prefix]
  rt-3:
    description: "The system SHALL serve thread lists at GET /g/{group}"
    status: Complete
    tested-by: [py-thread-list-loads]
  rt-4:
    description: "The system SHALL serve thread views at GET /g/{group}/thread/{message_id}"
    status: Complete
    tested-by: [py-thread-view-loads]
  rt-5:
    description: "The system SHALL serve article views at GET /a/{message_id}"
    status: Complete
    tested-by: [py-article-view-from-thread]
  rt-6:
    description: "The system SHALL serve compose form at GET /g/{group}/compose"
    status: Complete
    tested-by: [py-compose-accessible-auth]
  rt-7:
    description: "The system SHALL handle post submission at POST /g/{group}/post"
    status: Complete
    tested-by: [py-submit-new-post]
  rt-8:
    description: "The system SHALL handle reply submission at POST /a/{message_id}/reply"
    status: Complete
    tested-by: [py-submit-reply]
  rt-9:
    description: "The system SHALL serve login page at GET /auth/login"
    status: Complete
    tested-by: [py-login-page-loads]
  rt-10:
    description: "The system SHALL serve provider login at GET /auth/login/{provider}"
    status: Complete
    tested-by: [py-complete-login-flow]
  rt-11:
    description: "The system SHALL handle OAuth callback at GET /auth/callback/{provider}"
    status: Complete
    tested-by: [py-complete-login-flow]
  rt-12:
    description: "The system SHALL handle logout at POST /auth/logout"
    status: Complete
    tested-by: [py-logout-clears-session]
  rt-13:
    description: "The system SHALL serve privacy policy at GET /privacy"
    status: Complete
    tested-by: [py-privacy-page]
  rt-14:
    description: "The system SHALL serve health check at GET /health"
    status: Complete
    tested-by: [py-health-endpoint]
  rt-15:
    description: "The system SHALL serve static files at GET /static/*"
    status: Complete
    tested-by: [py-css-loads, py-js-loads]
  rt-16:
    description: "Each request SHALL have a unique request ID for log correlation"
    status: Complete
    tested-by: [py-request-id-logged]
test-cases:
  py-homepage-loads:
    name: "test_homepage_loads"
    file: "tests/integration/test_home.py"
    description: "Given homepage URL, when accessed, then page loads with main content"
    passing: true
    type: integration
  py-homepage-shows-groups:
    name: "test_homepage_shows_groups"
    file: "tests/integration/test_home.py"
    description: "Given homepage, when loaded, then displays available newsgroups"
    passing: true
    type: integration
  py-homepage-has-search:
    name: "test_homepage_has_search_input"
    file: "tests/integration/test_home.py"
    description: "Given homepage, when loaded, then has search/filter input"
    passing: true
    type: integration
  py-group-search-filters:
    name: "test_group_search_filters_results"
    file: "tests/integration/test_home.py"
    description: "Given homepage search, when typing, then filters displayed groups"
    passing: true
    type: integration
  py-browse-test-prefix:
    name: "test_browse_test_prefix"
    file: "tests/integration/test_home.py"
    description: "Given /browse/test URL, when accessed, then shows test group hierarchy"
    passing: true
    type: integration
  py-breadcrumb-navigation:
    name: "test_breadcrumb_navigation"
    file: "tests/integration/test_home.py"
    description: "Given browse page, when viewing subgroups, then breadcrumbs present"
    passing: true
    type: integration
  py-click-group-navigates:
    name: "test_click_group_navigates"
    file: "tests/integration/test_home.py"
    description: "Given homepage, when clicking group card, then navigates to group"
    passing: true
    type: integration
  py-css-loads:
    name: "test_css_loads"
    file: "tests/integration/test_home.py"
    description: "Given page load, when CSS requested, then loads successfully"
    passing: true
    type: integration
  py-js-loads:
    name: "test_js_loads"
    file: "tests/integration/test_home.py"
    description: "Given page load, when JavaScript requested, then executes correctly"
    passing: true
    type: integration
  py-thread-list-loads:
    name: "test_thread_list_loads"
    file: "tests/integration/test_threads.py"
    description: "Given valid group, when accessing /g/{group}, then page loads"
    passing: true
    type: integration
  py-thread-list-shows-threads:
    name: "test_thread_list_shows_threads"
    file: "tests/integration/test_threads.py"
    description: "Given seeded group, when loading thread list, then displays threads"
    passing: true
    type: integration
  py-thread-has-subject:
    name: "test_thread_has_subject"
    file: "tests/integration/test_threads.py"
    description: "Given thread list, when viewing, then each thread has subject line"
    passing: true
    type: integration
  py-thread-has-author:
    name: "test_thread_has_author"
    file: "tests/integration/test_threads.py"
    description: "Given thread list, when viewing, then threads display author"
    passing: true
    type: integration
  py-click-thread-opens-view:
    name: "test_click_thread_opens_view"
    file: "tests/integration/test_threads.py"
    description: "Given thread list, when clicking thread, then opens thread view"
    passing: true
    type: integration
  py-thread-view-loads:
    name: "test_thread_view_loads"
    file: "tests/integration/test_threads.py"
    description: "Given thread link, when navigating, then thread view loads"
    passing: true
    type: integration
  py-thread-view-shows-articles:
    name: "test_thread_view_shows_articles"
    file: "tests/integration/test_threads.py"
    description: "Given thread view, when loaded, then displays articles"
    passing: true
    type: integration
  py-thread-view-has-reply:
    name: "test_thread_view_has_reply_button"
    file: "tests/integration/test_threads.py"
    description: "Given thread view, when authenticated, then has reply button"
    passing: true
    type: integration
  py-pagination-present:
    name: "test_pagination_present_when_needed"
    file: "tests/integration/test_threads.py"
    description: "Given many threads, when viewing list, then pagination appears"
    passing: true
    type: integration
  py-invalid-group-error:
    name: "test_invalid_group_shows_error"
    file: "tests/integration/test_threads.py"
    description: "Given invalid group, when accessing, then shows error"
    passing: true
    type: integration
  py-privacy-page:
    name: "test_privacy_page_loads"
    file: "tests/integration/test_home.py"
    description: "Given /privacy URL, when accessed, then privacy policy page loads"
    passing: true
    type: integration
  py-health-endpoint:
    name: "test_health_endpoint"
    file: "tests/integration/test_home.py"
    description: "Given /health URL, when accessed, then returns 200 OK with 'ok' body"
    passing: true
    type: integration
  py-request-id-logged:
    name: "test_request_id_in_logs"
    file: "tests/integration/test_http_headers.py"
    description: "Given HTTP request, when logs checked, then includes request_id field"
    passing: true
    type: integration
---
# =============================================================================
# Feature 10: Cache-Control Headers
# =============================================================================
feature: "Cache-Control Headers"
phase: Complete
version: 1
changelog: |
  ## [1]
  ### Added
  - Initial feature tracking from existing codebase
decisions:
  - All responses include stale-while-revalidate for CDN resilience
  - All responses include stale-if-error for thundering herd protection
  - Cache durations based on content mutability
  - Auth and post routes have no caching
known-issues: []
requirements:
  cc-1:
    description: "Article responses SHALL have max-age of 1 hour with stale-while-revalidate of 60 seconds"
    status: Complete
    tested-by: [rust-cc-article]
  cc-2:
    description: "Thread view responses SHALL have max-age of 2 seconds with stale-while-revalidate of 5 seconds"
    status: Complete
    tested-by: [rust-cc-thread-view]
  cc-3:
    description: "Thread list responses SHALL have max-age of 2 seconds with stale-while-revalidate of 5 seconds"
    status: Complete
    tested-by: [rust-cc-thread-list]
  cc-4:
    description: "Home and browse responses SHALL have max-age of 60 seconds with stale-while-revalidate of 30 seconds"
    status: Complete
    tested-by: [rust-cc-home]
  cc-5:
    description: "Static file responses SHALL have max-age of 1 day with immutable hint"
    status: Complete
    tested-by: [rust-cc-static]
  cc-6:
    description: "All non-static responses SHALL include stale-if-error of 5 minutes"
    status: Complete
    tested-by: [rust-cc-stale-if-error]
  cc-7:
    description: "Error responses SHALL have max-age of 5 seconds"
    status: Complete
    tested-by: [rust-cc-error]
  cc-8:
    description: "Auth route responses SHALL NOT include cache headers"
    status: Complete
    tested-by: [py-cc-auth-no-cache]
  cc-9:
    description: "Post route responses SHALL NOT include cache headers"
    status: Complete
    tested-by: [py-cc-post-no-cache]
  cc-10:
    description: "Health check responses SHALL NOT include cache headers"
    status: Complete
    tested-by: [py-cc-health-no-cache]
test-cases:
  rust-cc-article:
    name: "test_cache_control_article"
    file: "src/config.rs"
    description: "Given CACHE_CONTROL_ARTICLE, then contains max-age=3600 and stale-while-revalidate=60"
    passing: true
    type: unit
  rust-cc-thread-view:
    name: "test_cache_control_thread_view"
    file: "src/config.rs"
    description: "Given CACHE_CONTROL_THREAD_VIEW, then contains max-age=2 and stale-while-revalidate=5"
    passing: true
    type: unit
  rust-cc-thread-list:
    name: "test_cache_control_thread_list"
    file: "src/config.rs"
    description: "Given CACHE_CONTROL_THREAD_LIST, then contains max-age=2 and stale-while-revalidate=5"
    passing: true
    type: unit
  rust-cc-home:
    name: "test_cache_control_home"
    file: "src/config.rs"
    description: "Given CACHE_CONTROL_HOME, then contains max-age=60 and stale-while-revalidate=30"
    passing: true
    type: unit
  rust-cc-static:
    name: "test_cache_control_static"
    file: "src/config.rs"
    description: "Given CACHE_CONTROL_STATIC, then contains max-age=86400 and immutable"
    passing: true
    type: unit
  rust-cc-stale-if-error:
    name: "test_cache_control_stale_if_error"
    file: "src/config.rs"
    description: "Given non-static cache headers, then all contain stale-if-error=300"
    passing: true
    type: unit
  rust-cc-error:
    name: "test_cache_control_error"
    file: "src/config.rs"
    description: "Given CACHE_CONTROL_ERROR, then contains max-age=5"
    passing: true
    type: unit
  py-cc-auth-no-cache:
    name: "test_auth_login_no_cache_control"
    file: "tests/integration/test_http_headers.py"
    description: "Given /auth/login request, when response checked, then no Cache-Control max-age"
    passing: true
    type: integration
  py-cc-post-no-cache:
    name: "test_post_redirect_no_cache_control"
    file: "tests/integration/test_http_headers.py"
    description: "Given post submission, when redirect response checked, then no Cache-Control max-age"
    passing: true
    type: integration
  py-cc-health-no-cache:
    name: "test_health_no_cache_control"
    file: "tests/integration/test_http_headers.py"
    description: "Given /health request, when response checked, then no Cache-Control header"
    passing: true
    type: integration
---
# =============================================================================
# Feature 11: Static File Serving
# =============================================================================
feature: "Static File Serving"
phase: Complete
version: 1
changelog: |
  ## [1]
  ### Added
  - Initial feature tracking from existing codebase
decisions:
  - Static files served from theme directories with fallback
  - Path traversal protection implemented
  - Long cache with immutable hint for fingerprinted assets
known-issues: []
requirements:
  sf-1:
    description: "The system SHALL serve static files from the active theme's static directory"
    status: Complete
    tested-by: [rust-static-rejects-parent-dir, rust-static-rejects-hidden-files]
  sf-2:
    description: "The system SHALL reject paths containing parent directory references (..)"
    status: Complete
    tested-by: [rust-static-rejects-parent-dir]
  sf-3:
    description: "The system SHALL reject paths to hidden files (starting with .)"
    status: Complete
    tested-by: [rust-static-rejects-hidden-files]
  sf-4:
    description: "The system SHALL fall back to default theme if file not found in active theme"
    status: Complete
    tested-by: [manual-sf-theme-fallback]
  sf-5:
    description: "Static file responses SHALL include Cache-Control with immutable hint"
    status: Complete
    tested-by: [rust-cc-static]
test-cases:
  rust-static-rejects-parent-dir:
    name: "test_validate_path_rejects_parent_dir"
    file: "src/http/static_files.rs"
    description: "Given path with .., when validating, then returns None"
    passing: true
    type: unit
  rust-static-rejects-hidden-files:
    name: "test_validate_path_rejects_hidden"
    file: "src/http/static_files.rs"
    description: "Given path starting with ., when validating, then returns None"
    passing: true
    type: unit
  manual-sf-theme-fallback:
    name: "manual_test_sf_theme_fallback"
    file: "manual"
    description: "Manual: 1) Create theme with partial static files. 2) Start September with that theme. 3) Request missing static file. 4) Verify it's served from default theme."
    passing: true
    type: manual
---
# =============================================================================
# Feature 12: Theming System
# =============================================================================
feature: "Theming System"
phase: Complete
version: 1
changelog: |
  ## [1]
  ### Added
  - Initial feature tracking from existing codebase
decisions:
  - Templates loaded from theme directory with fallback to default
  - Static files follow same layering pattern
  - Theme directory configurable (production vs development paths)
known-issues: []
requirements:
  th-1:
    description: "The system SHALL load templates from the configured theme directory"
    status: Complete
    tested-by: [manual-th-load-templates]
  th-2:
    description: "When a template is not found in the active theme, the system SHALL fall back to the default theme"
    status: Complete
    tested-by: [manual-th-fallback]
  th-3:
    description: "The theme directory base path SHALL be configurable"
    status: Complete
    tested-by: [rust-theme-config-themes-dir]
  th-4:
    description: "The active theme name SHALL be configurable"
    status: Complete
    tested-by: [rust-theme-config-name]
  th-5:
    description: "Static files SHALL follow the same theme layering as templates"
    status: Complete
    tested-by: [manual-sf-theme-fallback]
test-cases:
  manual-th-load-templates:
    name: "manual_test_th_load_templates"
    file: "manual"
    description: "Manual: 1) Start September with custom theme directory. 2) Access any page. 3) Verify page renders (templates loaded successfully)."
    passing: true
    type: manual
  manual-th-fallback:
    name: "manual_test_th_fallback"
    file: "manual"
    description: "Manual: 1) Create theme with partial templates (missing some). 2) Start September with that theme. 3) Verify missing templates fall back to default theme."
    passing: true
    type: manual
  rust-theme-config-themes-dir:
    name: "test_theme_config_default_themes_dir"
    file: "src/config.rs"
    description: "Given ThemeConfig default, then themes_dir equals /usr/share/september/themes"
    passing: true
    type: unit
  rust-theme-config-name:
    name: "test_theme_config_default_name"
    file: "src/config.rs"
    description: "Given ThemeConfig default, then name equals 'default'"
    passing: true
    type: unit

---
# =============================================================================
# Feature 13: OIDC Authentication
# =============================================================================
feature: "OIDC Authentication"
phase: Complete
version: 1
changelog: |
  ## [1]
  ### Added
  - Initial feature tracking from existing codebase
decisions:
  - Supports both OIDC discovery mode and manual OAuth2 endpoint configuration
  - PKCE used for all authorization flows
  - State parameter provides CSRF protection
  - Multiple providers can be configured
known-issues: []
requirements:
  oidc-1:
    description: "The system SHALL support OIDC discovery mode via issuer_url"
    status: Complete
    tested-by: [rust-oidc-discovery-valid]
  oidc-2:
    description: "The system SHALL support manual OAuth2 mode with explicit endpoints"
    status: Complete
    tested-by: [rust-oidc-manual-valid]
  oidc-3:
    description: "The system SHALL reject configuration with both discovery and manual endpoints"
    status: Complete
    tested-by: [rust-oidc-discovery-manual-conflict]
  oidc-4:
    description: "The system SHALL support multiple OIDC providers"
    status: Complete
    tested-by: [py-login-page-loads]
  oidc-5:
    description: "When only one provider is configured, login SHALL redirect directly to that provider"
    status: Complete
    tested-by: [manual-oidc-single-provider-redirect]
  oidc-6:
    description: "When multiple providers are configured, login SHALL show a provider selection page"
    status: Complete
    tested-by: [py-login-page-loads]
  oidc-7:
    description: "The system SHALL use PKCE for authorization flows"
    status: Complete
    tested-by: [py-oidc-pkce]
  oidc-8:
    description: "The system SHALL validate state parameter to prevent CSRF attacks"
    status: Complete
    tested-by: [rust-auth-flow-state-valid, rust-auth-flow-state-invalid]
  oidc-9:
    description: "The system SHALL support configurable userinfo subject field for OAuth2 providers"
    status: Complete
    tested-by: [rust-oidc-userinfo-sub-field-default]
  oidc-10:
    description: "The system SHALL support return_to parameter for post-login redirect"
    status: Complete
    tested-by: [py-login-with-return-to]
  oidc-11:
    description: "The system SHALL validate provider name is URL-safe"
    status: Complete
    tested-by: [rust-oidc-name-invalid-chars, rust-oidc-name-empty]
test-cases:
  rust-oidc-discovery-valid:
    name: "test_oidc_provider_validate_discovery_valid"
    file: "src/config.rs"
    description: "Given provider with issuer_url, when validated, then succeeds"
    passing: true
    type: unit
  rust-oidc-manual-valid:
    name: "test_oidc_provider_validate_manual_valid"
    file: "src/config.rs"
    description: "Given provider with manual endpoints, when validated, then succeeds"
    passing: true
    type: unit
  rust-oidc-discovery-manual-conflict:
    name: "test_oidc_provider_validate_discovery_and_manual_conflict"
    file: "src/config.rs"
    description: "Given provider with both modes, when validated, then fails"
    passing: true
    type: unit
  rust-oidc-name-invalid-chars:
    name: "test_oidc_provider_validate_name_invalid_chars"
    file: "src/config.rs"
    description: "Given provider with invalid name chars, when validated, then fails"
    passing: true
    type: unit
  rust-oidc-name-empty:
    name: "test_oidc_provider_validate_name_empty"
    file: "src/config.rs"
    description: "Given provider with empty name, when validated, then fails"
    passing: true
    type: unit
  py-login-page-loads:
    name: "test_login_page_loads"
    file: "tests/integration/test_auth.py"
    description: "Given /auth/login URL, when accessed, then shows login options"
    passing: true
    type: integration
  py-login-link-in-header:
    name: "test_login_link_in_header"
    file: "tests/integration/test_auth.py"
    description: "Given unauthenticated user, when viewing page, then login link visible"
    passing: true
    type: integration
  py-complete-login-flow:
    name: "test_complete_login_flow"
    file: "tests/integration/test_auth.py"
    description: "Given Dex provider, when completing login, then user authenticated"
    passing: true
    type: integration
  py-login-with-return-to:
    name: "test_login_with_return_to"
    file: "tests/integration/test_auth.py"
    description: "Given return_to parameter, when login completes, then redirects to return path"
    passing: true
    type: integration
  manual-oidc-single-provider-redirect:
    name: "manual_test_oidc_single_provider_redirect"
    file: "manual"
    description: "Manual: 1) Configure only one OIDC provider. 2) Access /auth/login. 3) Verify immediate redirect to provider (no selection page shown)."
    passing: true
    type: manual
  py-oidc-pkce:
    name: "test_oauth_redirect_includes_pkce_parameters"
    file: "tests/integration/test_auth.py"
    description: "Given login flow, when redirect URL captured, then includes code_challenge and code_challenge_method=S256"
    passing: true
    type: integration
  rust-auth-flow-state-valid:
    name: "test_auth_flow_state_validate_state_valid"
    file: "src/oidc/session.rs"
    description: "Given matching state parameter, when validated, then returns true"
    passing: true
    type: unit
  rust-auth-flow-state-invalid:
    name: "test_auth_flow_state_validate_state_invalid"
    file: "src/oidc/session.rs"
    description: "Given mismatching state parameter, when validated, then returns false"
    passing: true
    type: unit
  rust-oidc-userinfo-sub-field-default:
    name: "test_oidc_provider_userinfo_sub_field_default"
    file: "src/config.rs"
    description: "Given OidcProviderConfig, then userinfo_sub_field defaults to 'sub'"
    passing: true
    type: unit
---
# =============================================================================
# Feature 14: Session Management
# =============================================================================
feature: "Session Management"
phase: Complete
version: 1
changelog: |
  ## [1]
  ### Added
  - Initial feature tracking from existing codebase
decisions:
  - Sessions stored in signed HTTP-only cookies
  - Cookie signing key derived from cookie_secret using HKDF
  - Session expiry stored in session data
  - CSRF token generated per session
known-issues: []
requirements:
  sm-1:
    description: "The system SHALL store session data in signed HTTP-only cookies"
    status: Complete
    tested-by: [py-cookie-httponly, py-cookie-samesite]
  sm-3:
    description: "Sessions SHALL expire after configurable session_lifetime_days (default 30)"
    status: Complete
    tested-by: [rust-user-new-sets-expiry, rust-user-expired-false-fresh, rust-user-expired-true-past]
  sm-4:
    description: "The system SHALL check session expiry on each request"
    status: Complete
    tested-by: [manual-sm-expiry-check]
  sm-5:
    description: "Each session SHALL have a unique CSRF token"
    status: Complete
    tested-by: [rust-csrf-valid, rust-csrf-invalid, rust-csrf-different-length]
  sm-6:
    description: "The system SHALL support secret resolution from env:, file:, or literal"
    status: Complete
    tested-by: [rust-secret-literal, rust-secret-env, rust-secret-env-missing, rust-secret-file, rust-secret-file-missing]
  sm-7:
    description: "File-based secrets SHALL be trimmed of whitespace"
    status: Complete
    tested-by: [rust-secret-file]
  sm-8:
    description: "Session data SHALL persist across page navigation"
    status: Complete
    tested-by: [py-session-persists-navigation]
  sm-9:
    description: "Logout SHALL clear the session cookie"
    status: Complete
    tested-by: [py-logout-clears-session]
test-cases:
  rust-user-new-sets-expiry:
    name: "test_user_new_sets_expiry"
    file: "src/oidc/session.rs"
    description: "Given User::new(), when called, then expiry set to now + lifetime"
    passing: true
    type: unit
  rust-user-expired-false-fresh:
    name: "test_user_is_expired_false_when_fresh"
    file: "src/oidc/session.rs"
    description: "Given fresh user, when checking expiry, then returns false"
    passing: true
    type: unit
  rust-user-expired-true-past:
    name: "test_user_is_expired_true_when_past"
    file: "src/oidc/session.rs"
    description: "Given expired user, when checking expiry, then returns true"
    passing: true
    type: unit
  rust-secret-literal:
    name: "test_resolve_secret_literal"
    file: "src/config.rs"
    description: "Given literal secret, when resolved, then returns value unchanged"
    passing: true
    type: unit
  rust-secret-env:
    name: "test_resolve_secret_env"
    file: "src/config.rs"
    description: "Given env:VAR, when resolved, then returns environment value"
    passing: true
    type: unit
  rust-secret-env-missing:
    name: "test_resolve_secret_env_missing"
    file: "src/config.rs"
    description: "Given env:MISSING, when resolved, then returns error"
    passing: true
    type: unit
  rust-secret-file:
    name: "test_resolve_secret_file"
    file: "src/config.rs"
    description: "Given file:path, when resolved, then returns trimmed file contents"
    passing: true
    type: unit
  rust-secret-file-missing:
    name: "test_resolve_secret_file_missing"
    file: "src/config.rs"
    description: "Given file:missing, when resolved, then returns error"
    passing: true
    type: unit
  py-session-persists-navigation:
    name: "test_session_persists_across_navigation"
    file: "tests/integration/test_auth.py"
    description: "Given authenticated user, when navigating pages, then session persists"
    passing: true
    type: integration
  py-logout-clears-session:
    name: "test_logout_clears_session"
    file: "tests/integration/test_auth.py"
    description: "Given authenticated user, when logging out, then session cleared"
    passing: true
    type: integration
  py-cookie-httponly:
    name: "test_session_cookie_httponly"
    file: "tests/integration/test_auth.py"
    description: "Given authenticated session, when cookie inspected, then has HttpOnly flag"
    passing: true
    type: integration
  py-cookie-samesite:
    name: "test_session_cookie_samesite"
    file: "tests/integration/test_auth.py"
    description: "Given authenticated session, when cookie inspected, then has SameSite flag"
    passing: true
    type: integration
  manual-sm-expiry-check:
    name: "manual_test_sm_expiry_check"
    file: "manual"
    description: "Manual: 1) Log in. 2) Wait for session lifetime to expire (or modify cookie expiry). 3) Access authenticated page. 4) Verify treated as unauthenticated."
    passing: true
    type: manual
  rust-csrf-valid:
    name: "test_user_validate_csrf_valid"
    file: "src/oidc/session.rs"
    description: "Given matching CSRF token, when validated, then returns true"
    passing: true
    type: unit
  rust-csrf-invalid:
    name: "test_user_validate_csrf_invalid"
    file: "src/oidc/session.rs"
    description: "Given mismatching CSRF token, when validated, then returns false"
    passing: true
    type: unit
  rust-csrf-different-length:
    name: "test_user_validate_csrf_different_length"
    file: "src/oidc/session.rs"
    description: "Given different length CSRF token, when validated, then returns false"
    passing: true
    type: unit
---
# =============================================================================
# Feature 15: Article Viewing
# =============================================================================
feature: "Article Viewing"
phase: Complete
version: 1
changelog: |
  ## [1]
  ### Added
  - Initial feature tracking from existing codebase
decisions:
  - Articles displayed with headers (From, Subject, Date)
  - Block quotes stripped from previews
  - Date displayed as relative time (timeago filter)
known-issues: []
requirements:
  av-1:
    description: "The system SHALL display article headers (From, Subject, Date)"
    status: Complete
    tested-by: [py-article-shows-headers]
  av-2:
    description: "The system SHALL display article body content"
    status: Complete
    tested-by: [py-article-shows-body]
  av-3:
    description: "The system SHALL strip block quotes from article previews"
    status: Complete
    tested-by: [rust-strip-quotes-simple, rust-strip-quotes-attribution, rust-strip-quotes-ends]
  av-4:
    description: "The system SHALL display dates as relative time (e.g., '2 hours ago')"
    status: Complete
    tested-by: [rust-timeago-just-now, rust-timeago-minutes, rust-timeago-hours, rust-timeago-days, rust-timeago-invalid-returns-original]
  av-5:
    description: "The system SHALL provide navigation back to the group from article view"
    status: Complete
    tested-by: [py-back-to-group]
  av-6:
    description: "When an article is not found, the system SHALL display an error page"
    status: Complete
    tested-by: [py-invalid-article-error]
  av-7:
    description: "The system SHALL detect quote lines starting with >"
    status: Complete
    tested-by: [rust-is-quote-line-block]
  av-8:
    description: "The system SHALL detect attribution lines (e.g., 'On Date, Person wrote:')"
    status: Complete
    tested-by: [rust-is-quote-line-attribution]
  av-9:
    description: "Quotes in the middle of content SHALL be preserved"
    status: Complete
    tested-by: [rust-strip-quotes-preserves-middle]
test-cases:
  rust-strip-quotes-simple:
    name: "test_strip_block_quotes_simple"
    file: "src/templates.rs"
    description: "Given simple quoted text, when stripped, then only non-quoted remains"
    passing: true
    type: unit
  rust-strip-quotes-attribution:
    name: "test_strip_block_quotes_with_attribution_no_whitespace"
    file: "src/templates.rs"
    description: "Given attribution followed by quotes, when stripped, then both removed"
    passing: true
    type: unit
  rust-strip-quotes-ends:
    name: "test_strip_block_quotes_at_both_ends"
    file: "src/templates.rs"
    description: "Given quotes at start and end, when stripped, then middle content remains"
    passing: true
    type: unit
  rust-strip-quotes-preserves-middle:
    name: "test_strip_block_quotes_preserves_middle"
    file: "src/templates.rs"
    description: "Given quotes in middle, when stripped, then preserved"
    passing: true
    type: unit
  rust-strip-quotes-all:
    name: "test_strip_block_quotes_all_quotes"
    file: "src/templates.rs"
    description: "Given all quoted content, when stripped, then result is empty"
    passing: true
    type: unit
  rust-is-quote-line-block:
    name: "test_is_quote_line_block_quote"
    file: "src/templates.rs"
    description: "Given line starting with >, when checked, then returns true"
    passing: true
    type: unit
  rust-is-quote-line-attribution:
    name: "test_is_quote_line_attribution"
    file: "src/templates.rs"
    description: "Given attribution line, when checked, then returns true"
    passing: true
    type: unit
  rust-is-quote-line-not:
    name: "test_is_quote_line_not_quote"
    file: "src/templates.rs"
    description: "Given normal text, when checked, then returns false"
    passing: true
    type: unit
  py-article-view-from-thread:
    name: "test_article_view_from_thread"
    file: "tests/integration/test_articles.py"
    description: "Given thread view, when clicking article link, then article loads"
    passing: true
    type: integration
  py-article-shows-headers:
    name: "test_article_shows_headers"
    file: "tests/integration/test_articles.py"
    description: "Given article view, when loaded, then displays headers"
    passing: true
    type: integration
  py-article-shows-body:
    name: "test_article_shows_body"
    file: "tests/integration/test_articles.py"
    description: "Given article view, when loaded, then displays body"
    passing: true
    type: integration
  py-back-to-group:
    name: "test_back_to_group"
    file: "tests/integration/test_articles.py"
    description: "Given article view, when navigating back, then returns to group"
    passing: true
    type: integration
  py-header-navigation:
    name: "test_header_navigation"
    file: "tests/integration/test_articles.py"
    description: "Given any page, when viewing header, then has navigation"
    passing: true
    type: integration
  py-invalid-article-error:
    name: "test_invalid_article_shows_error"
    file: "tests/integration/test_articles.py"
    description: "Given invalid article ID, when accessed, then shows error"
    passing: true
    type: integration
  rust-timeago-just-now:
    name: "test_compute_timeago_just_now"
    file: "src/nntp/mod.rs"
    description: "Given current time, when computing timeago, then returns 'just now'"
    passing: true
    type: unit
  rust-timeago-minutes:
    name: "test_compute_timeago_minutes"
    file: "src/nntp/mod.rs"
    description: "Given time 5 minutes ago, when computing timeago, then returns '5 minutes ago'"
    passing: true
    type: unit
  rust-timeago-hours:
    name: "test_compute_timeago_hours"
    file: "src/nntp/mod.rs"
    description: "Given time 3 hours ago, when computing timeago, then returns '3 hours ago'"
    passing: true
    type: unit
  rust-timeago-days:
    name: "test_compute_timeago_days"
    file: "src/nntp/mod.rs"
    description: "Given time 5 days ago, when computing timeago, then returns '5 days ago'"
    passing: true
    type: unit
  rust-timeago-invalid-returns-original:
    name: "test_compute_timeago_invalid_date_returns_original"
    file: "src/nntp/mod.rs"
    description: "Given invalid date string, when computing timeago, then returns original string"
    passing: true
    type: unit
---
# =============================================================================
# Feature 16: Article Posting
# =============================================================================
feature: "Article Posting"
phase: Complete
version: 1
changelog: |
  ## [1]
  ### Added
  - Initial feature tracking from existing codebase
decisions:
  - Posting requires authentication with valid email
  - CSRF token required for all post/reply submissions
  - Group must allow posting (checked via NNTP capabilities)
  - Poll for new post visibility after submission
known-issues: []
requirements:
  ap-1:
    description: "The compose page SHALL require authentication"
    status: Complete
    tested-by: [py-compose-requires-auth]
  ap-2:
    description: "When authenticated, the compose page SHALL display a form with subject and body fields"
    status: Complete
    tested-by: [py-compose-has-fields]
  ap-3:
    description: "The compose form SHALL include a CSRF token"
    status: Complete
    tested-by: [py-compose-has-csrf]
  ap-4:
    description: "Posts with empty subject SHALL be rejected"
    status: Complete
    tested-by: [py-empty-subject-rejected]
  ap-5:
    description: "Unauthenticated POST to /g/{group}/post SHALL return 401"
    status: Complete
    tested-by: [py-unauth-post-rejected]
  ap-6:
    description: "Unauthenticated POST to /a/{message_id}/reply SHALL return 401"
    status: Complete
    tested-by: [py-unauth-reply-rejected]
  ap-7:
    description: "The user SHALL have a valid email to post"
    status: Complete
    tested-by: [manual-ap-valid-email]
  ap-8:
    description: "The group SHALL allow posting (checked via NNTP capabilities)"
    status: Complete
    tested-by: [manual-ap-group-posting-capability]
  ap-9:
    description: "After successful post, the system SHALL poll for visibility"
    status: Complete
    tested-by: [manual-ap-poll-visibility]
  ap-10:
    description: "Reply form SHALL be available on thread/article view when authenticated"
    status: Complete
    tested-by: [py-reply-form-available]
  ap-11:
    description: "Successful post submission SHALL redirect away from compose page"
    status: Complete
    tested-by: [py-submit-new-post]
test-cases:
  py-compose-requires-auth:
    name: "test_compose_requires_auth"
    file: "tests/integration/test_posting.py"
    description: "Given unauthenticated user, when accessing compose, then requires auth"
    passing: true
    type: integration
  py-compose-accessible-auth:
    name: "test_compose_accessible_when_authenticated"
    file: "tests/integration/test_posting.py"
    description: "Given authenticated user, when accessing compose, then form displayed"
    passing: true
    type: integration
  py-compose-has-fields:
    name: "test_compose_form_has_required_fields"
    file: "tests/integration/test_posting.py"
    description: "Given compose form, when displayed, then has subject and body fields"
    passing: true
    type: integration
  py-compose-has-csrf:
    name: "test_compose_form_has_csrf_token"
    file: "tests/integration/test_posting.py"
    description: "Given compose form, when displayed, then has CSRF token"
    passing: true
    type: integration
  py-submit-new-post:
    name: "test_submit_new_post"
    file: "tests/integration/test_posting.py"
    description: "Given valid post data, when submitted, then redirects to group/thread"
    passing: true
    type: integration
  py-empty-subject-rejected:
    name: "test_empty_subject_rejected"
    file: "tests/integration/test_posting.py"
    description: "Given empty subject, when submitting, then rejected"
    passing: true
    type: integration
  py-reply-form-available:
    name: "test_reply_form_available"
    file: "tests/integration/test_posting.py"
    description: "Given authenticated user on thread view, when viewing, then reply form available"
    passing: true
    type: integration
  py-submit-reply:
    name: "test_submit_reply"
    file: "tests/integration/test_posting.py"
    description: "Given valid reply data, when submitted, then stays on thread page"
    passing: true
    type: integration
  py-unauth-post-rejected:
    name: "test_unauthenticated_post_submission_rejected"
    file: "tests/integration/test_posting.py"
    description: "Given unauthenticated request, when POSTing to /g/{group}/post, then 401"
    passing: true
    type: integration
  py-unauth-reply-rejected:
    name: "test_unauthenticated_reply_submission_rejected"
    file: "tests/integration/test_posting.py"
    description: "Given unauthenticated request, when POSTing to /a/{id}/reply, then 401"
    passing: true
    type: integration
  py-compose-shows-auth-required:
    name: "test_compose_page_shows_auth_required"
    file: "tests/integration/test_posting.py"
    description: "Given unauthenticated user, when viewing compose, then shows auth message"
    passing: true
    type: integration
  manual-ap-valid-email:
    name: "manual_test_ap_valid_email"
    file: "manual"
    description: "Manual: 1) Log in with OIDC account that has no email. 2) Attempt to post. 3) Verify error message about setting email."
    passing: true
    type: manual
  manual-ap-group-posting-capability:
    name: "manual_test_ap_group_posting_capability"
    file: "manual"
    description: "Manual: 1) Configure server without POST capability. 2) Access compose page for that server's group. 3) Verify posting is disabled with appropriate message."
    passing: true
    type: manual
  manual-ap-poll-visibility:
    name: "manual_test_ap_poll_visibility"
    file: "manual"
    description: "Manual: 1) Submit new post. 2) Observe redirect behavior. 3) Verify post appears in thread view after redirect completes."
    passing: true
    type: manual
---
# =============================================================================
# Feature 17: Production Readiness
# =============================================================================
feature: "Production Readiness"
phase: Complete
version: 1
changelog: |
  ## [1]
  ### Added
  - Initial feature tracking from existing codebase
decisions:
  - Health endpoint for container orchestration
  - Graceful shutdown with 30-second connection drain
  - SIGHUP for certificate hot-reload in manual TLS mode
  - JSON structured logging option for production
  - Packaging for deb, rpm, and tarball distribution
known-issues: []
requirements:
  pr-1:
    description: "The system SHALL expose a health check endpoint at GET /health"
    status: Complete
    tested-by: [py-health-endpoint]
  pr-2:
    description: "The health endpoint SHALL return 200 OK with body 'ok'"
    status: Complete
    tested-by: [py-health-endpoint]
  pr-3:
    description: "When receiving SIGTERM or SIGINT, the system SHALL initiate graceful shutdown"
    status: Complete
    tested-by: [manual-pr-graceful-shutdown]
  pr-4:
    description: "Graceful shutdown SHALL wait up to 30 seconds for connections to drain"
    status: Complete
    tested-by: [manual-pr-shutdown-timeout]
  pr-5:
    description: "When receiving SIGHUP in manual TLS mode, the system SHALL reload certificates"
    status: Complete
    tested-by: [manual-pr-sighup-reload]
  pr-6:
    description: "The system SHALL support JSON structured log format"
    status: Complete
    tested-by: [manual-pr-json-log]
  pr-7:
    description: "The system SHALL support text human-readable log format"
    status: Complete
    tested-by: [manual-pr-text-log]
  pr-8:
    description: "Log format SHALL be configurable via config file or CLI"
    status: Complete
    tested-by: [manual-pr-log-format-config]
  pr-9:
    description: "The system SHALL support CLI option for config file path (-c/--config)"
    status: Complete
    tested-by: [manual-pr-cli-config]
  pr-10:
    description: "The system SHALL support CLI option for log level (-l/--log-level)"
    status: Complete
    tested-by: [manual-pr-cli-log-level]
  pr-11:
    description: "CLI log level SHALL override environment variable RUST_LOG"
    status: Complete
    tested-by: [manual-pr-cli-override-env]
  pr-12:
    description: "The system SHALL support packaging as .deb for Debian/Ubuntu"
    status: Complete
    tested-by: [manual-pr-deb-package]
  pr-13:
    description: "The system SHALL support packaging as .rpm for RHEL/Fedora"
    status: Complete
    tested-by: [manual-pr-rpm-package]
  pr-14:
    description: "Package SHALL include systemd service unit file"
    status: Complete
    tested-by: [manual-pr-systemd-unit]
  pr-15:
    description: "Package SHALL include man page"
    status: Complete
    tested-by: [manual-pr-man-page]
  pr-16:
    description: "TLS configuration SHALL support ACME mode for automatic Let's Encrypt certificates"
    status: Complete
    tested-by: [rust-tls-acme-valid]
  pr-17:
    description: "TLS configuration SHALL support manual mode with user-provided certificates"
    status: Complete
    tested-by: [rust-tls-manual-valid]
  pr-18:
    description: "TLS configuration SHALL support none mode for plain HTTP"
    status: Complete
    tested-by: [rust-tls-none-ok]
  pr-19:
    description: "ACME mode SHALL require acme_domains configuration"
    status: Complete
    tested-by: [rust-tls-acme-missing-domains]
  pr-20:
    description: "ACME mode SHALL require acme_email configuration"
    status: Complete
    tested-by: [rust-tls-acme-missing-email]
  pr-21:
    description: "Manual TLS mode SHALL require cert_path configuration"
    status: Complete
    tested-by: [rust-tls-manual-missing-cert]
  pr-22:
    description: "Manual TLS mode SHALL require key_path configuration"
    status: Complete
    tested-by: [rust-tls-manual-missing-key]
test-cases:
  rust-tls-none-ok:
    name: "test_tls_config_validate_none_ok"
    file: "src/config.rs"
    description: "Given TLS mode none, when validated, then succeeds"
    passing: true
    type: unit
  rust-tls-acme-missing-domains:
    name: "test_tls_config_validate_acme_missing_domains"
    file: "src/config.rs"
    description: "Given ACME mode without domains, when validated, then fails"
    passing: true
    type: unit
  rust-tls-acme-missing-email:
    name: "test_tls_config_validate_acme_missing_email"
    file: "src/config.rs"
    description: "Given ACME mode without email, when validated, then fails"
    passing: true
    type: unit
  rust-tls-acme-valid:
    name: "test_tls_config_validate_acme_valid"
    file: "src/config.rs"
    description: "Given complete ACME config, when validated, then succeeds"
    passing: true
    type: unit
  rust-tls-manual-missing-cert:
    name: "test_tls_config_validate_manual_missing_cert"
    file: "src/config.rs"
    description: "Given manual mode without cert, when validated, then fails"
    passing: true
    type: unit
  rust-tls-manual-missing-key:
    name: "test_tls_config_validate_manual_missing_key"
    file: "src/config.rs"
    description: "Given manual mode without key, when validated, then fails"
    passing: true
    type: unit
  rust-tls-manual-valid:
    name: "test_tls_config_validate_manual_valid"
    file: "src/config.rs"
    description: "Given complete manual config, when validated, then succeeds"
    passing: true
    type: unit
  rust-tls-is-enabled:
    name: "test_tls_config_is_enabled"
    file: "src/config.rs"
    description: "Given TLS config, when checking is_enabled, then returns correct value"
    passing: true
    type: unit
  manual-pr-graceful-shutdown:
    name: "manual_test_pr_graceful_shutdown"
    file: "manual"
    description: "Manual: 1) Start September. 2) Send SIGTERM. 3) Verify logs show 'Shutting down gracefully'. 4) Verify process exits cleanly."
    passing: true
    type: manual
  manual-pr-shutdown-timeout:
    name: "manual_test_pr_shutdown_timeout"
    file: "manual"
    description: "Manual: 1) Start long-running request. 2) Send SIGTERM. 3) Verify logs show 'waiting up to 30 seconds'. 4) Verify request completes before shutdown."
    passing: true
    type: manual
  manual-pr-sighup-reload:
    name: "manual_test_pr_sighup_reload"
    file: "manual"
    description: "Manual: 1) Start September with manual TLS. 2) Replace cert files. 3) Send SIGHUP. 4) Verify logs show 'Reloading TLS certificates'. 5) Verify new cert is used."
    passing: true
    type: manual
  manual-pr-json-log:
    name: "manual_test_pr_json_log"
    file: "manual"
    description: "Manual: 1) Set log_format='json' in config. 2) Start September. 3) Verify logs are JSON objects with timestamp, level, message, and span fields."
    passing: true
    type: manual
  manual-pr-text-log:
    name: "manual_test_pr_text_log"
    file: "manual"
    description: "Manual: 1) Set log_format='text' in config. 2) Start September. 3) Verify logs are human-readable text with timestamps and colors."
    passing: true
    type: manual
  manual-pr-log-format-config:
    name: "manual_test_pr_log_format_config"
    file: "manual"
    description: "Manual: 1) Set log_format='json' in config. 2) Start September. 3) Verify JSON logs. 4) Change to log_format='text'. 5) Restart, verify text logs."
    passing: true
    type: manual
  manual-pr-cli-config:
    name: "manual_test_pr_cli_config"
    file: "manual"
    description: "Manual: 1) Run 'september --help'. 2) Verify -c/--config option documented. 3) Run 'september -c /path/to/config.toml'. 4) Verify config loaded from specified path."
    passing: true
    type: manual
  manual-pr-cli-log-level:
    name: "manual_test_pr_cli_log_level"
    file: "manual"
    description: "Manual: 1) Run 'september --help'. 2) Verify -l/--log-level option documented. 3) Run 'september -l debug'. 4) Verify debug logs appear."
    passing: true
    type: manual
  manual-pr-cli-override-env:
    name: "manual_test_pr_cli_override_env"
    file: "manual"
    description: "Manual: 1) Set RUST_LOG=warn. 2) Run 'september -l debug'. 3) Verify debug logs appear (CLI overrides env)."
    passing: true
    type: manual
  manual-pr-deb-package:
    name: "manual_test_pr_deb_package"
    file: "manual"
    description: "Manual: 1) Run release workflow. 2) Verify .deb artifact produced. 3) Install on Debian/Ubuntu. 4) Verify september binary in /usr/bin."
    passing: true
    type: manual
  manual-pr-rpm-package:
    name: "manual_test_pr_rpm_package"
    file: "manual"
    description: "Manual: 1) Run release workflow. 2) Verify .rpm artifact produced. 3) Install on RHEL/Fedora. 4) Verify september binary in /usr/bin."
    passing: true
    type: manual
  manual-pr-systemd-unit:
    name: "manual_test_pr_systemd_unit"
    file: "manual"
    description: "Manual: 1) Check dist/september.service exists. 2) Verify unit file has [Unit], [Service], [Install] sections. 3) After package install, verify file in /lib/systemd/system/."
    passing: true
    type: manual
  manual-pr-man-page:
    name: "manual_test_pr_man_page"
    file: "manual"
    description: "Manual: 1) Check dist/september.1 exists. 2) Run 'man ./dist/september.1'. 3) Verify man page displays with NAME, SYNOPSIS, OPTIONS sections."
    passing: true
    type: manual
